name: ${COMPOSE_PROJECT_NAME:-botberi_prod}
services:
  user_backend:
    build:
      context: .
      dockerfile: services/user_backend/Dockerfile
      args:
        INSTALL_DEV: "false"
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-8010} --workers 4
    env_file:
      - environments/prod/user_backend.env.example
    ports:
      - "8010:8010"
    depends_on:
      user_psql:
        condition: service_healthy
      shared_psql:
        condition: service_healthy
      user_redis:
        condition: service_started
      event_bus:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  admin_backend:
    build:
      context: .
      dockerfile: services/admin_backend/Dockerfile
      args:
        INSTALL_DEV: "false"
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-8020} --workers 3
    env_file:
      - environments/prod/admin_backend.env.example
    ports:
      - "8020:8020"
    depends_on:
      shared_psql:
        condition: service_healthy
      event_bus:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  event_broker:
    build:
      context: .
      dockerfile: services/event_broker/Dockerfile
      args:
        INSTALL_DEV: "false"
    command: >
      uvicorn app.main:app --host 0.0.0.0 --port ${API_PORT:-8030} --workers 2
    env_file:
      - environments/prod/event_broker.env.example
    ports:
      - "8030:8030"
    depends_on:
      shared_psql:
        condition: service_healthy
      event_bus:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  celery_worker:
    build:
      context: .
      dockerfile: services/user_backend/Dockerfile
      args:
        INSTALL_DEV: "false"
    command: celery -A app.core.celery_app worker -l info
    env_file:
      - environments/prod/user_backend.env.example
    depends_on:
      event_bus:
        condition: service_started
      user_redis:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  flower:
    image: mher/flower:2.0.1
    command: >
      celery --broker=${RABBITMQ_URL:-amqp://guest:guest@event_bus:5672//} flower --port=4400 --persistent
    env_file:
      - environments/prod/user_backend.env.example
    ports:
      - "4400:4400"
    depends_on:
      event_bus:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  user_psql:
    image: postgres:16
    env_file:
      - environments/prod/user_psql.env.example
    ports:
      - "5430:5432"
    volumes:
      - user_psql_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - botberi_net
    restart: unless-stopped

  shared_psql:
    image: postgres:16
    env_file:
      - environments/prod/shared_psql.env.example
    ports:
      - "5440:5432"
    volumes:
      - shared_psql_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - botberi_net
    restart: unless-stopped

  user_redis:
    image: redis:7-alpine
    env_file:
      - environments/prod/user_redis.env.example
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6600:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - botberi_net
    restart: unless-stopped

  event_bus:
    image: rabbitmq:3.13-management
    env_file:
      - environments/prod/rabbitmq.env.example
    ports:
      - "5672:5672"
      - "15672:15672"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - botberi_net
    restart: unless-stopped

  nginx:
    build:
      context: ./infra/nginx
    ports:
      - "8080:80"
    depends_on:
      user_backend:
        condition: service_started
      admin_backend:
        condition: service_started
    networks:
      - botberi_net
    restart: unless-stopped

  grafana:
    image: grafana/grafana:10.4.5
    ports:
      - "4600:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_ADMIN_PASSWORD:-change-me}
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning
      - grafana_data:/var/lib/grafana
    networks:
      - botberi_net
    restart: unless-stopped

networks:
  botberi_net:
    name: ${NETWORK_NAME:-botberi_net}

volumes:
  user_psql_data:
  shared_psql_data:
  rabbitmq_data:
  grafana_data:


